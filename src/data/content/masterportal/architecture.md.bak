# Masterportal Architektur verstehen

## Ãœberblick

Das Masterportal Version 3 folgt einer **komponentenbasierten Architektur** auf Basis von **Vue 3** und **Vuex**. Das VerstÃ¤ndnis dieser Architektur ist essentiell, um eigene Tools zu entwickeln.

## Architektur-Diagramm

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Masterportal v3 (Vue 3 + Vuex)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Core      â”‚  â”‚   Modules    â”‚  â”‚  Addons   â”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚           â”‚ â”‚
â”‚  â”‚ - Map        â”‚  â”‚ - Tools      â”‚  â”‚ - Custom  â”‚ â”‚
â”‚  â”‚ - Vuex Store â”‚  â”‚ - Menu       â”‚  â”‚   Logic   â”‚ â”‚
â”‚  â”‚ - i18n       â”‚  â”‚ - Controls   â”‚  â”‚           â”‚ â”‚
â”‚  â”‚ - API Bridge â”‚  â”‚ - SearchBar  â”‚  â”‚           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           OpenLayers (Karten-Engine)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Vue 3 + Vuex 4 (Framework)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Technologie-Stack

**Masterportal v3 basiert auf:**

- **Vue 3** (v3.5.22): JavaScript-Framework mit Composition API
- **Vuex 4** (v4.1.0): State Management
- **OpenLayers**: Karten-Engine
- **Bootstrap 5** (v5.3.8): UI-Components
- **Webpack 4** (v4.47.0): Build-System
- **i18next** (v25.5.2): Internationalisierung
- **Axios** (v1.12.2): HTTP-Client
- **Chart.js** (v4.5.0): Diagramme

**Wichtig:** Version 3 ist eine komplette Neuentwicklung und nutzt **Vue 3** statt Backbone.js aus Version 2!

## Core-Komponenten

### 1. Map (Karte)

Verwaltet die OpenLayers-Karte zentral:

```javascript
// Ãœber den Vuex Store zugreifen
import {mapGetters} from "vuex";

export default {
    computed: {
        ...mapGetters("Maps", ["getLayerById", "getMap"])
    },
    methods: {
        addLayerToMap() {
            const map = this.getMap("2D");
            map.addLayer(myLayer);
        }
    }
};
```

### 2. Vuex Store

Zentrales State Management mit mehreren Modulen:

```
store/
â”œâ”€â”€ index.js              # Root Store
â”œâ”€â”€ Maps/                 # Karten-Verwaltung
â”œâ”€â”€ Tools/                # Tool-States
â”‚   â”œâ”€â”€ Draw/
â”‚   â”œâ”€â”€ Measure/
â”‚   â””â”€â”€ MeinTool/
â”œâ”€â”€ Menu/                 # MenÃ¼-State
â””â”€â”€ Language/             # i18n-State
```

**Typischer Store-Zugriff:**

```javascript
import {mapState, mapGetters, mapActions, mapMutations} from "vuex";

export default {
    computed: {
        ...mapState("Tools/Draw", ["active", "drawType"]),
        ...mapGetters("Tools/Draw", ["isDrawing"])
    },
    methods: {
        ...mapActions("Tools/Draw", ["startDrawing"]),
        ...mapMutations("Tools/Draw", ["setActive"])
    }
};
```

### 3. i18n (Internationalisierung)

Alle Texte werden Ã¼ber i18next verwaltet:

```javascript
// In Templates
{{ $t("common:button.save") }}
{{ $t("additional:modules.tools.measure.title") }}

// In JavaScript
this.$t("common:button.save")
```

**Ãœbersetzungsdateien:**
```
locales/
â”œâ”€â”€ de/
â”‚   â”œâ”€â”€ common.json
â”‚   â””â”€â”€ additional.json
â””â”€â”€ en/
    â”œâ”€â”€ common.json
    â””â”€â”€ additional.json
```

### 4. MasterportalAPI

Bridge zu OpenLayers-FunktionalitÃ¤t:

```javascript
import {getDistance} from "ol/sphere";
import {getArea, getLength} from "ol/sphere";

// Direkter Zugriff auf OpenLayers-Funktionen
const distance = getDistance(coord1, coord2);
```

## Module-Struktur

### Tools

Tools sind Vue-Komponenten mit eigenem Vuex-Store:

```
src/modules/tools/
â”œâ”€â”€ draw/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â””â”€â”€ Draw.vue          # Vue-Komponente
â”‚   â”œâ”€â”€ store/
â”‚   â”‚   â”œâ”€â”€ index.js          # Store-Konfiguration
â”‚   â”‚   â”œâ”€â”€ actions.js        # Async-Logik
â”‚   â”‚   â”œâ”€â”€ mutations.js      # State-Ã„nderungen
â”‚   â”‚   â”œâ”€â”€ getters.js        # Abgeleitete Werte
â”‚   â”‚   â””â”€â”€ state.js          # Initialer State
â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â””â”€â”€ unit/             # Unit-Tests
â”‚   â””â”€â”€ doc/                  # Dokumentation
```

### Controls

UI-Controls wie Zoom, Scale, etc.:

```
src/modules/controls/
â”œâ”€â”€ zoom/
â”œâ”€â”€ orientation/
â””â”€â”€ totalView/
```

### Menu

MenÃ¼-System (Desktop/Mobile/Table):

```
src/modules/menu/
â”œâ”€â”€ desktop/
â”œâ”€â”€ mobile/
â””â”€â”€ table/
```

## Vue 3 Konzepte

### 1. Vue-Komponenten

**Options API (Standard in Masterportal v3):**

```vue
<script>
export default {
    name: "MeineTool",
    data() {
        return {
            count: 0
        };
    },
    computed: {
        doubleCount() {
            return this.count * 2;
        }
    },
    methods: {
        increment() {
            this.count++;
        }
    },
    mounted() {
        console.log("Component mounted");
    }
};
</script>

<template>
    <div>
        <p>Count: {{ count }}</p>
        <p>Double: {{ doubleCount }}</p>
        <button @click="increment">+1</button>
    </div>
</template>

<style lang="scss" scoped>
div {
    padding: 1rem;
}
</style>
```

**Composition API (modern, optional):**

```vue
<script>
import {ref, computed, onMounted} from "vue";

export default {
    name: "MeinTool",
    setup() {
        const count = ref(0);
        const doubleCount = computed(() => count.value * 2);
        
        const increment = () => {
            count.value++;
        };
        
        onMounted(() => {
            console.log("Component mounted");
        });
        
        return {count, doubleCount, increment};
    }
};
</script>
```

### 2. Vuex Store

**State:** Der "Single Source of Truth"

```javascript
// state.js
const state = {
    active: false,
    selectedFeatures: [],
    distance: null
};

export default state;
```

**Mutations:** Synchrone State-Ã„nderungen

```javascript
// mutations.js
export default {
    setActive(state, value) {
        state.active = value;
    },
    setDistance(state, distance) {
        state.distance = distance;
    }
};
```

**Actions:** Asynchrone Logik

```javascript
// actions.js
export default {
    async fetchData({commit}) {
        const data = await fetch("/api/data");
        commit("setData", data);
    },
    
    calculateDistance({state, commit}) {
        // Logik...
        commit("setDistance", result);
    }
};
```

**Getters:** Abgeleitete Werte

```javascript
// getters.js
export default {
    isActive: (state) => state.active,
    hasFeatures: (state) => state.selectedFeatures.length > 0,
    featureCount: (state) => state.selectedFeatures.length
};
```

## OpenLayers Integration

### Layer-Management

```javascript
// Layer zur Karte hinzufÃ¼gen
import VectorLayer from "ol/layer/Vector";
import VectorSource from "ol/source/Vector";

const vectorLayer = new VectorLayer({
    id: "myToolLayer",
    source: new VectorSource(),
    alwaysOnTop: true
});

const map = this.getMap("2D");
map.addLayer(vectorLayer);
```

### Interaktionen

```javascript
import {Select, Draw} from "ol/interaction";
import {click} from "ol/events/condition";

// Feature-Selektion
const select = new Select({
    condition: click,
    style: highlightStyle
});

map.addInteraction(select);

select.on("select", (evt) => {
    const features = evt.target.getFeatures().getArray();
    this.setSelectedFeatures(features);
});
```

### Geometrie-Operationen

```javascript
import {getDistance, getLength, getArea} from "ol/sphere";

// Distanz zwischen Punkten
const distance = getDistance([lon1, lat1], [lon2, lat2]);

// LÃ¤nge einer Linie
const length = getLength(lineStringGeometry);

// FlÃ¤che eines Polygons
const area = getArea(polygonGeometry);
```

## Datenfluss im Masterportal v3

```
User-Aktion (z.B. Button-Click)
    â†“
Vue-Komponente fÃ¤ngt Event ab (@click="...")
    â†“
Komponente ruft Vuex Action auf
    â†“
Action verarbeitet Logik (API-Calls, Berechnungen)
    â†“
Action committed Mutation(s)
    â†“
Mutation Ã¤ndert State
    â†“
Vue Reactivity triggert Re-Render
    â†“
UI wird aktualisiert
```

## Best Practices

### 1. Vuex fÃ¼r State Management

âœ… **Gut:**
```javascript
// In Action
commit("setSelectedFeatures", features);

// In Komponente
computed: {
    ...mapState("Tools/MeinTool", ["selectedFeatures"])
}
```

âŒ **Schlecht:**
```javascript
// State direkt in Komponente
data() {
    return {
        selectedFeatures: []  // Nicht teilbar zwischen Komponenten
    };
}
```

### 2. Cleanup beim Deaktivieren

âœ… **Gut:**
```javascript
// In Action
deactivate({commit, rootState}) {
    // Layer entfernen
    const map = rootState.Maps.map;
    const layer = map.getLayerById("myToolLayer");
    if (layer) {
        map.removeLayer(layer);
    }
    
    // State zurÃ¼cksetzen
    commit("clearSelection");
    commit("setActive", false);
}
```

### 3. i18n fÃ¼r alle Texte

âœ… **Gut:**
```vue
<template>
    <h4>{{ $t("additional:modules.tools.meinTool.title") }}</h4>
</template>
```

âŒ **Schlecht:**
```vue
<template>
    <h4>Mein Tool</h4>  <!-- Hardcoded Deutsch -->
</template>
```

## Migration von v2 zu v3

Falls du alte Tools im Repository siehst:

| Backbone (v2) | Vue 3 (v3) |
|---------------|------------|
| `Model.extend()` | Vuex Store Module |
| `View.extend()` | Vue-Komponente (.vue) |
| `this.get("prop")` | `this.prop` (computed) |
| `this.set("prop", val)` | `commit("setProp", val)` |
| `this.listenTo(model, "change")` | `watch()` oder computed |
| jQuery DOM | Vue Template Syntax |
| `template:` String | `<template>` Block |

## Debugging-Workflow

### 1. Vue DevTools

Browser-Extension fÃ¼r:
- Vuex State inspizieren
- Component-Tree visualisieren
- Events tracken

### 2. Console-Logs in Actions

```javascript
export default {
    calculateDistance({state, commit}) {
        console.log("Calculating distance for:", state.selectedFeatures);
        const result = /* ... */;
        console.log("Result:", result);
        commit("setDistance", result);
    }
};
```

### 3. Vuex Logger

```javascript
// store/index.js
import {createLogger} from "vuex";

const plugins = process.env.NODE_ENV !== "production" 
    ? [createLogger()] 
    : [];

export default new Vuex.Store({
    // ...
    plugins
});
```

## WeiterfÃ¼hrende Ressourcen

- **Vue 3 Dokumentation:** https://vuejs.org/
- **Vuex 4 Dokumentation:** https://vuex.vuejs.org/
- **OpenLayers API:** https://openlayers.org/en/latest/apidoc/
- **Masterportal Doku:** https://www.masterportal.org/dokumentation
- **Beispiel-Tools:** `src/modules/tools/` im Repository

## Zusammenfassung

Das Masterportal v3 kombiniert:
- **Vue 3** fÃ¼r komponentenbasierte UI
- **Vuex 4** fÃ¼r zentrales State Management
- **OpenLayers** fÃ¼r Karten-FunktionalitÃ¤t
- **i18next** fÃ¼r Mehrsprachigkeit
- **Bootstrap 5** fÃ¼r konsistentes UI

Diese moderne Architektur ermÃ¶glicht wartbare und skalierbare Geo-Anwendungen! ðŸ—ï¸

